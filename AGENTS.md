# AGENTS.md

このドキュメントは、throwtrash-Android プロジェクトで作業する Codex CLI 向けのガイドラインを定義する。

## エージェントの目的
- Android（Kotlin）アプリの品質と保守性を維持しながら、機能追加・改善・修正を安全に進める。
- モジュラモノリス + レイヤードアーキテクチャの構成に沿って変更を行う。

## 共通方針
### 基本事項
- 日本語で応答すること。
- 必要に応じて、ユーザーに質問を行い、要求を明確にすること。
- ユーザーがあなたに質問をした場合（疑問形での問いかけ）は指示ではない。ユーザーの意見をそのまま受け取って実装を行うのではなく、あなたの考えを述べた上でユーザーに指示を仰ぐこと。
- 作業後、作業内容とユーザーが次に取れる行動を説明すること。
- 次の作業へ進む指示が出た際に git に未反映の内容がある場合は git commit してから作業を開始する。
- コミットメッセージには semantic commit を用いる。
- リモート Push の可否は必ずユーザーに確認する。
- コマンドの出力が確認できない場合、get last command / check background terminal を使用して確認すること。
- コマンドが権限不足やネットワークエラーで失敗する場合、自力で解消を試みないこと。ユーザーに質問し、指示を仰ぐこと。
- 作業開始前には必ず調査レポートおよびタスク一覧の存在を確認し、新規に作成が必要か判断すること。

### コードの書き方
- コードのコメントは日本語で記載すること。
- コメントはコードの意図や動作を明確にするために記すこと。コードを見れば明らかな内容はコメントしないこと。

### テストの実装
- コードを新規に作成した場合は、必ずテストコードも実装すること。
- テストコードは、実装した機能が正しく動作することを確認するためのものである。
- テストコードは、実装した機能の主要な動作をカバーすること。
- カバレッジを 100% にする必要はないが、主要な機能が正しく動作することを確認できるようにすること。
- テストは「単体テスト」と「UI テスト」に分けて実装すること。
  - 単体テストは業務ロジックに対して実装することを基本とし、UI コードに対しては原則として実装しないこと。
  - 単体テストは関数単位でテストケースを作成し、正常系と異常系を実装すること。
  - 言語の制約で関数名に日本語が許容される場合は、テストケースの関数名は日本語とすること。それ以外の場合は、テスト内容が分かるようにテストコード内のコメントで補足すること。
  - UI テストはユーザー操作のシナリオに対して実装することを基本とすること。ファイル単位・プログラム単位には実装しないこと。
  - UI テストは全てのシナリオを網羅する必要はないが、シナリオごとに正常系と異常系のテストを実施すること。

## プロジェクト固有の前提
- アプリは Kotlin / Android（Compose + ViewBinding）構成。
- 依存性注入は Dagger を使用。
- テストは JUnit5 + Mockito を使用し、`app/src/test` に単体テスト、`app/src/androidTest` に UI テストがある。
- フレーバーは `dev` / `prod`、ビルドタイプは `debug` / `release`。
- 機密情報は `local.properties` や環境変数に保持されるため、リポジトリ内に書き込まない。

## ディレクトリ構成（主要）
- `app/src/main/java/net/mythrowaway/app/application`: Android 依存の初期化や DI
- `app/src/main/java/net/mythrowaway/app/module`: 機能ごとのモジュール（dto/entity/infra/presentation/service/usecase）
- `app/src/main/java/net/mythrowaway/app/ui`: UI テーマ関連
- `app/src/test`: 単体テスト
- `app/src/androidTest`: UI テスト

## 開発手順
### 「調査」の指示
- チャットでの要求に対して、必要な情報を明確にするための質問を行うこと。
- 利用する技術やツール、サービス API など最新の情報が必要な場合、その都度 Web 検索を行うこと。関連する MCP があれば随時 MCP サーバーから情報を取得すること。
- レポートの記録を指示されている場合は、プロジェクト内に Markdown 形式で記録すること。

### 「計画」の指示
- プロジェクト内に Markdown 形式で計画ファイルを作成すること。
- 計画ファイルの作成場所が指定されていない場合はユーザーに確認すること。
- 各タスクには進捗状況が分かるように、未着手・進行中・完了のいずれかを EMOJI で記載すること。
- コードベースとプロジェクト内のドキュメントを読み込み、要件に関連性のあるファイルパスをすべて記載すること。
- このフェーズでは、コードベースの修正を行わないこと。
- コードベースの修正計画に合わせて、ドキュメント修正も計画すること。
- 可能な限りタスクを細分化し、各タスクが独立して実行できるようにすること。
- 作成した計画は必ずユーザーの了承を得ること。了承を得た場合のみ実装フェーズに進むこと。

### 「実装」の指示
- 計画で作成したタスク一覧に基づいて実装を行うこと。必ず対応する計画ファイルが存在することを確認する。
- 実装前に `Context7 MCP Server` を利用し、`resolve-library-id` → `get-library-docs` で関連ライブラリの最新情報を取得する。
- 記載されている以上の実装を行わないこと。
- コードの新規作成・修正が必要な場合、必ずテストコードも作成・修正すること。
- 非推奨の API を使用している場合、可能な限り最新の API に置き換えること。
- ソースコードの修正後は `./gradlew lint` を実行し、可能な限り自動修正を行う。
  また`copilot -p "<レビュー依頼内容>" --add-dir .` コマンドを実行し、コードレビューを依頼する。指摘された内容に基づき、必要な修正を行う。
- テストは必要に応じて以下を実行する。
  - 単体テスト: `./gradlew testDebugUnitTest`
  - UI テスト: `./gradlew connectedDebugAndroidTest`（デバイス/エミュレータが必要）
  - カバレッジ: `./gradlew jacocoTestReport`
- テストまで完了したら、プロジェクト内のドキュメントを見直し、修正後のコードベースと齟齬がないことを確認すること。差異がある場合はドキュメントを修正すること。
- 実装作業が完了したタイミングまたは計画変更や状況の変化が発生した場合には、タスク一覧を更新すること。

## エージェントの分割
- ユーザーからの要求が大規模な場合、複数のエージェントに分割して対応することを検討する。
- エージェントの役割分担例は以下のとおりとする。
- *管理エージェント*
  - プロジェクト全体の進捗管理を担当する
  - ユーザーの要求を分析し、作業エージェントで対応すべきタスク分割を行う。
  - work/tasks/main 内に全体の作業計画を作成し、work/tasks/agents 内に作業エージェント用のタスクリストを作成する。
  - 各エージェントの作業環境はgit worktreeを用いて分離管理する。作業計画作成後にworktreeの作成を行う。
  - worktreeは../worktrees 内に作成する。
  - work/tasks/agents 内のタスクリストはエージェント間で共有可能なように、各worktree/work/tasks内にシンボリックリンクを展開する。
  - 作業エージェントからの報告を受け取りタスクリストとレポート及びgit logを確認し、マージする。
  - 完了したタスクのタスクリストは削除するか、保管が必要な場合はwork/tasks/archive/ に退避する。

- *作業エージェント*
  - 管理エージェントから割り当てられたタスクを実行する。
  - タスクはgit worktreeを用いて分離された環境で実行する前提とする。
  - タスクリストはwork/tasks 内にシンボリックで提供される。
  - 必要に応じてタスクの詳細化や調査を行う。また作業の過程で変更の必要性が生じた場合はタスクリストを変更する。
  - 実装作業はガイドラインに従い、逐次ユーザーに報告する。
  - タスクが完了しユーザーの了承を得たのちに変更をコミットする。
  - コミット後に作業結果を管理エージェントと共有できるように、作業内容をwork/tasks/reports 内に生成する。
- エージェントを分割する場合には、必ずユーザーに確認を取ること。
